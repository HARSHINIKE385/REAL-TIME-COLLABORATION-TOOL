<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Local Collaborative Editor</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
  <style>
    body { font-family: monospace; margin:0; height:100vh; display:flex; flex-direction:column; }
    #editor { flex:1; }
  </style>
</head>
<body>
  <textarea id="editor">// Waiting for server...</textarea>
  <script>
    const ws = new WebSocket("ws://127.0.0.1:8765/"); // connect to your local server
    let editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
      lineNumbers: true,
      mode: "javascript"
    });
    let localVersion = -1;
    let localChange = false;

    ws.onopen = () => {
      console.log("Connected to WebSocket server");
      ws.send(JSON.stringify({type:"request_full"}));
    };

    ws.onmessage = (ev) => {
      const msg = JSON.parse(ev.data);
      if(msg.type === "full") {
        localChange = true;
        editor.setValue(msg.text);
        localVersion = msg.version;
        localChange = false;
      }
    };

    let debounceTimer = null;
    editor.on("change", () => {
      if(localChange) return;
      if(debounceTimer) clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        ws.send(JSON.stringify({
          type: "patch",
          text: editor.getValue(),
          version: localVersion
        }));
      }, 250);
    });
  </script>
</body>
</html>
